<!DOCTYPE html>
<html lang="zh">
    <head>
        <title>Marked heading link Test</title>
        <meta charset="UTF-8">
        <meta name="description" content="" />
        <meta name="keywords" content="" />
        <link rel="stylesheet" href="../examples/css/style.css" />
    </head>
    <body>
        <script src="../examples/js/jquery.min.js"></script>
        <script src="../lib/marked.min.js"></script>
        <script type="text/javascript">
                
            var linkReg = /\s*\<family\s*href\=\"(.*)\"\s*([^\>]*)\>(.*)\<\/family\>\s*/;
            var linkTextReg = /\s*\<family\s*([^\>]+)\>([^\>]*)\<\/family\>\s*/g;
            
            var testLink = "<family href=\"http://daringfireball.net/projects/markdown/basics\" title=\"Markdown Basics\">Markdown Basics</family> ";
            var testLink2 = "<family href=\"http://daringfireball.net/projects/markdown/basics\" title=\"Xdfsdf\">Xdfsdf</family> ";
            var testLink3 = "<family href=\"\" title=\"\"></family> ";
            var texts = (testLink + testLink2 + testLink3).split(/\<family\s*([^\>]+)\>([^\>]*)\<\/family\>/);
            
            console.log(texts);
            
            for (var i = 0, len = texts.length; i < len; i++)
            {
                if((i+1) % 3 == 0) console.log(texts[i]);
            }
            
            (testLink + testLink2).replace(linkTextReg, function(){
                //console.log($1, $2);
                //console.log("linkText =>", $3);
                console.log(arguments);
            });
            
            testLink.replace(linkTextReg, function($1, $2, $3){
                console.log($1, $2, $3);
            });
            
            console.log(linkReg.test(" <family name=\"dddd\" class=\"link\" style=\"color:red;\">Markdown Basics</family> "));
            
            console.log(linkReg.test("<family name=\"dddd\" href=\"http://daringfireball.com/projects/markdown/basics\" class=\"link\" style=\"color:red;\">Markdown Basics</family> "));
            
            console.log(linkReg.test("<family  href=\"http://daringfireball.net/projects/markdown/basics?xx=ddd&fddf&temp=265656565665656526\"   title=\"dddd\" class=\"link\" style=\"color:red;\">Markdown Basics</family> "));
            
            console.log(linkReg.test("<family  href=\"http://daringfireball.net/projects/markdown/basics\"   title=\"dddd\"><span>Markdown Basics</span></family> "));
            
            console.log(linkReg.test("<family  href=\"http://daringfireball.net/projects/markdown/basics?xx=ddd&fddf&temp=265656565665656526\"   title=\"dddd\"><span class=\"active\">Markdown Basics</span></family> "));
            console.log(linkReg.test("<family  href=\"http://www.fdasfasdfsdaf.com/projects/markdown/basics\"   title=\"dddd\"><family href=\"#ddd\" class=\"active\">Markdown Basics</family></family> "));
            console.log(linkReg.test("afdsfasfsadf<family  href=\"http://daringfireball.net/projects/markdown/basics?xx=ddd&fddf&temp=265656565665656526\"   title=\"dddd\"><family href=\"#ddd\" class=\"active\">Markdown Basics</family></family> fdasfasdfadsfsfd <family  href=\"http://daringfireball.net/projects/markdown/basics\"   title=\"dddd\"><span>Markdown Basics</span></family>"));
            
            $(function() {
                var markedRenderer     = new marked.Renderer();
                var markdownToC        = markdownToC || [];

                markedRenderer.heading = function(text, level, raw) {
                    
                    var linkText       = text;
                    var hasLinkReg     = /\s*\<family\s*href\=\"(.*)\"\s*([^\>]*)\>(.*)\<\/family\>\s*/;
                    var getLinkTextReg = /\s*\<family\s*([^\>]+)\>([^\>]*)\<\/family\>\s*/g;
                    
                    if (hasLinkReg) {
                        var tempText = [];
                        text = text.split(/\<family\s*([^\>]+)\>([^\>]*)\<\/family\>/);

                        console.log(text);

                        for (var i = 0, len = text.length; i < len; i++)
                        {
                            if((i+1) % 3 == 0) tempText.push(text[i]);
                        }    
                        
                        text = tempText.join(" ");
                    }         
                    
                    var escapedText    = text.toLowerCase().replace(/[^\w]+/g, "-");
                    var toc = {
                        text : text,
                        level : level,
                        slug  : escapedText
                    };
                    
                    console.log("text =>", text);

                    var isChinese = /^[\u4e00-\u9fa5]+$/.test(text);
                    var id = (isChinese) ? escape(text).replace(/\%/g, "") : text.toLowerCase().replace(/[^\w]+/g, "-");

                    markdownToC.push(toc);
                    
                    console.log("toc =>", toc);
                    
                    var headingHTML = "<h" + level + " id=\"h"+ level + "-" + this.options.headerPrefix + id +"\">";

                    /*return "<h" + level + " id=\"h"+ level + "-" + this.options.headerPrefix + id +"\">" +
                           "<family href=\"#" + text + "\" name=\"" + text + "\" class=\"anchor\"></family>" +
                           "<span class=\"header-link\"></span>" + text + "</h" + level + ">";*/
                    
                    var anchor = "<family name=\"" + text + "\" class=\"anchor\"></family>";
                    
                    headingHTML += anchor;
                    
                    headingHTML += "<span class=\"header-link\"></span>";
                    
                    headingHTML += (hasLinkReg) ? linkText : text;
                    
                    headingHTML += "</h" + level + ">";
                    
                    return headingHTML;
                    
                };
            
                marked.setOptions({
                    renderer    : markedRenderer,
                    gfm         : true,
                    tables      : true,
                    breaks      : true,
                    pedantic    : false,
                    smartLists  : true,
                    smartypants : true
                });
                
                var md = marked("## [Markdown Basics](http://daringfireball.net/projects/markdown/basics \"Markdown Basics\")");
                console.log(md);
                
                var md2 = marked("## fdasfsd [Markdown Basics](http://daringfireball.net/projects/markdown/basics \"Markdown Basics\") xxx  [Editor.md](http://daringfireball.net/projects/markdown/basics \"Editor.md\") fadsfasdfasdf");
                console.log(md2);
                
                var md3 = marked("### fdasfsd中文链接 [中文链接](http://daringfireball.net/projects/markdown/basics \"中文链接\") xxx 中文链接 [Editor.md 在线Markdown编辑器](http://daringfireball.net/projects/markdown/basics \"Editor.md 在线Markdown编辑器\") fadsfasdfasdf中文链接");
                console.log(md3);
                
                var md4 = marked("#### fdasfsd [Markdown Basics](http://daringfireball.net/projects/markdown/basics?xx=ddd&fddf&temp=265656565665656526 \"Markdown Basics\") xxx  [Editor.md](http://www.ipandao.com/#xxxxx \"Editor.md\") fadsfasdfasdf");
                console.log(md4);
                
                $("body").append(md).append(md2).append(md3).append(md4);
            });
        </script>
    </body>
</html>